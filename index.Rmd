---
title: "Melt the cl<i class='far fa-clock' style='font-size:52px'></i>ck"
subtitle: "tidy time series analysis <hr>"
type: "contributed"
author: "<br> Earo Wang <br> <i class='fab fa-twitter' style='color:#6CADDE'></i> <i class='fab fa-github'></i> @earowang"
date: "slides at [slides.earo.me/rstudioconf19](https://slides.earo.me/rstudioconf19)"
output:
  xaringan::moon_reader:
    css: ["default", "libs/remark.css"]
    lib_dir: libs
    nature:
      ratio: 16:9
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{r initial, echo = FALSE, cache = FALSE, results = 'hide'}
library(knitr)
options(htmltools.dir.version = FALSE, tibble.width = 50, tibble.print_min = 4)
opts_chunk$set(
  echo = FALSE, warning = FALSE, message = FALSE, comment = "#>",
  fig.path = 'figure/', cache.path = 'cache/', fig.align = 'center', 
  fig.width = 12, fig.show = 'hold', fig.height = 8.5, # 16:9
  cache = TRUE, external = TRUE, dev = 'svglite'
)
read_chunk('R/theme.R')
read_chunk('R/main.R')
```

```{r theme-remark}
```

## Today we'll learn

.center[
### 1 unified tidy time series workflow `r emo::ji("bangbang")`
]
<br>

.pull-left[
### 2 packages `r emo::ji("package")`
.center[
<img src="img/tsibble.png" height=180px>
<img src="img/fable.png" height=180px>
]
]
.pull-right[
### 3 big ideas `r emo::ji("bulb")`
1. tsibble
2. mable
3. fable
]

???

I'll explain three big ideas or tibbles both abstractly and concretely with
data examples.

---

## Tidy data workflow

.center[
![](img/r4ds.svg)
]

The underlying data structure: tibble

---

## Current time series workflow `r emo::ji("frowning_face")`

.center[
![](img/r4ts.svg)
]

The mésalliance between temporal data and time series models

---

## Tidy time series workflow `r emo::ji("smiley")`

.center[
![](img/r4tidyverts.svg)
]

The underlying data structure: tsibble

---

# An example: electricity consumption

```{r load}
```

.footnote[[Data source: Department of the Environment and Energy, Australia](https://data.gov. au/dataset/4e21dea3-9b87-4610-94c7-15a8a77907ef)]

---
class: inverse middle center

.animated.bounce[
<img src="img/tsibble.png" height=280px>
]

## Modern time series standard

---

## Time series has its own semantics

```{r coerce, echo = TRUE}
```

* **key**:
* **index**:

---

## Contextual pretty printing

```{r print, highlight.output = 1:2}
```

---

## Look at data early: time gaps

```{r line-na, fig.height = 2.3}
```

```r
elec_ts %>% fill_gaps()
```

```{r fill-gaps, fig.height = 2.3}
```

???

## Implicit missing value handlers

<br>
1. Check with `has_gaps()`
2. Report with `scan_gaps()`
3. Summarise with `count_gaps()`
4. Fill in time gaps with `fill_gaps()`

---

## A new adjective `index_by()`: time-aware grouping

```{r index-by, echo = TRUE}
```

---

## Map and roll

.left-column[
<br>
<br>
![purrr-logo](https://raw.githubusercontent.com/rstudio/hex-stickers/master/PNG/purrr.png)
]

--

.right-column[
<div style="width:100%;height:0;padding-bottom:64%;position:relative;"><iframe src="https://giphy.com/embed/xoSaxIp8f9JPa" width="100%" height="100%" style="position:absolute" frameBorder="0" class="giphy-embed" allowFullScreen></iframe></div><p><a href="https://giphy.com/gifs/cat-rolls-xoSaxIp8f9JPa"></a></p>
]

---

```{r jan}
```

.pull-left[
slide
![](img/slide.gif)
tile
![](img/tile.gif)
stretch
![](img/stretch.gif)
]
.pull-right[
<br>
<img src="img/window.png">
Type stability suffix: `*_dbl()`, `*_int()`, `*_lgl()`, `*_chr()`

Parallel processing prefix: `future_*`.
]

---

## A simple example

```{r moving-average, echo = TRUE}
```

```{r moving-average-plot, fig.height = 3}
```

---
class: inverse middle center

.animated.bounce[
<img src="img/fable.png" height=280px>
]

## Tidy forecasting

---

## Why fable?

> 1. It makes forecasting tables.
> 2. A fable is never true, but it tells you something important about reality.
>
> **Rob J Hyndman**

---

.right-column[
```{r split-data}
```

```{r calendar-train}
```
]

---

## mable: the `model()` generic

```{r model, echo = TRUE}
```

* succinct model representations
* `summarise()` semantics: reduces rows

???

Models are reduced representations of the data down to simplistic structures 
that are described by coefficients.

---

## Extract from mable

```{r sweep, error = TRUE, echo = TRUE}
```

---

## fable: `forecast()` the future

```{r forecast, echo = TRUE}
```

---

.left-column[
## Visualise fable
### - Naive
]
.right-column[
```{r vis-naive}
```
]

---

.left-column[
## Visualise fable
### - Naive
### - ETS
]
.right-column[
```{r vis-ets}
```
]

---

## Assess model performance

```{r accuracy, echo = TRUE, error = TRUE}
```

---

## Models are fundamentally scalable

```{r final, eval = FALSE, echo = TRUE}
```

```r
tsibble %>% 
  mable %>% 
  fable
```

---

## Much more in the tidyverts

* Decomposition `STL()`
* Simulation `simulate()`
* Interpolation `interpolate()`
* Refitting and streaming `refit()` & `stream()`

---

## Joint work

.center[
.portrait[
![](http://dicook.org/img/dicook-2014.jpg)
Di Cook <br>
<i class='fab fa-twitter' style='color:#6CADDE'></i> [@visnut](http://twitter.com/visnut)
]
.portrait[
![](https://robjhyndman.com/pics/RobHyndman-highres.jpg)
Rob J Hyndman <br>
<i class='fab fa-twitter' style='color:#6CADDE'></i> [@robjhyndman](http://twitter.com/robjhyndman)
]
.portrait[
![](https://d33wubrfki0l68.cloudfront.net/362995d299699959fe385c344e24331f9c0b256c/ecdb4/img/circle.jpg)
Mitchell O'Hara‑Wild <br>
<i class='fab fa-twitter' style='color:#6CADDE'></i> [@mitchoharawild](http://twitter.com/mitchoharawild)
]
]

---
class: middle center

.card[
.tidyverts[tidyver.orange[ts].org]
]
.card[
![](img/tsibble.png)
[pkg.earo.me/tsibble](https://pkg.earo.me/tsibble)
]
.card[
![](img/fable.png)
[github.com/tidyverts/fable](https://github.com/tidyverts/fable)
]
<br>
.card[
![](img/slides-title.png)
[slides.earo.me/rstudioconf19](https://slides.earo.me/rstudioconf19)
]
.card[
![](img/Octocat.png)
[github.com/earowang/rstudioconf19](https://github.com/earowang/rstudioconf19)
]
